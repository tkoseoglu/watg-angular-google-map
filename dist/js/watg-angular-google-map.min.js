/*! watg-angular-google-map 2016-07-22 */
!function(){"use strict";angular.module("watgGoogleMapModule",[])}(),function(){"use strict";function watgGoogleMapDirective($http){function link(scope,element){function handleLocationError(browserHasGeolocation,infoWindow,pos){infoWindow.setPosition(pos),infoWindow.setContent(browserHasGeolocation?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.")}function removeAllMarkers(){for(var i=0;i<scope.config.markers.length;i++)scope.config.markers[i].map=null;console.log("all markers removed")}function removeAllClusterMarkers(){for(var i=0;i<clusterMarkers.length;i++)clusterMarkers[i].setMap(null);clusterMarkers=[],void 0!==markerClusterer&&markerClusterer.clearMarkers(),console.log("all cluster markers removed")}function getRandomNumber(min,max){var ran=Math.random()*(max-min)+min;return ran}function initMap(){mapElement=document.getElementById("map"),map=new google.maps.Map(mapElement,{center:{lat:scope.config.lat,lng:scope.config.lon},zoom:scope.config.zoom,disableDefaultUI:scope.config.disableDefaultUI,mapTypeControl:scope.config.mapTypeControl,fullscreenControl:scope.config.fullscreenControl,disableAutoPan:scope.config.disableAutoPan,shadowStyle:scope.config.shadowStyle}),void 0!==scope.config.customMapTypes&&scope.config.customMapTypes.length>0&&(map.mapTypes.set(scope.selectedMapTypeId,scope.config.customMapTypes[0]),map.setMapTypeId(scope.selectedMapTypeId)),google.maps.event.trigger(map,"resize"),scope.config.showMyLocation&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(function(position){infoWindow=new google.maps.InfoWindow({map:map});var pos={lat:position.coords.latitude,lng:position.coords.longitude};infoWindow.setPosition(pos),infoWindow.setContent("You are here!")},function(){handleLocationError(!0,infoWindow,map.getCenter())}):handleLocationError(!1,infoWindow,map.getCenter())),scope.config.showDayNightOverlay&&new DayNightOverlay({map:map,fillColor:scope.config.dayNightOverlayFillColor||"rgba(0,0,0,0.3)"}),scope.$watchCollection("config.markers",function(newValue,oldValue){removeAllMarkers(),console.log("config.markers collection changed..."),scope.config.markers.length>0&&scope.config.markers.forEach(function(m){var contentUrl=m.contentUrl,markerInfowindow=new google.maps.InfoWindow,marker=new google.maps.Marker({position:{lat:m.lat,lng:m.lon},map:map,title:m.title,icon:m.icon});marker.addListener("click",function(){markerInfowindow.open(map,marker),getInfoWindowContent(contentUrl).then(function(result){markerInfowindow.setContent(result)})})})}),scope.$watchCollection("config.clusterMarkers",function(newValue,oldValue){if(removeAllClusterMarkers(),console.log("config.clusterMarkers collection changed..."),scope.config.clusterMarkers.length>0){var counter=0;scope.config.clusterMarkers.forEach(function(m){var latLng=new google.maps.LatLng(m.lat,m.lon);if(scope.config.fixOverlappingPins)for(var i=0;i<clusterMarkers.length;i++){var existingMarker=clusterMarkers[i],pos=existingMarker.getPosition();if(latLng.equals(pos)){var a=360/clusterMarkers.length,ran1=getRandomNumber(randomMin,randomMax),ran2=getRandomNumber(randomMin,randomMax),newLat=pos.lat()+ran1*Math.cos(+a*i/180*Math.PI),newLng=pos.lng()+ran2*Math.sin(+a*i/180*Math.PI);latLng=new google.maps.LatLng(newLat,newLng)}}var marker=new google.maps.Marker({position:latLng,title:m.title,icon:scope.config.customMarkerUrl,textColor:"white"}),contentUrl=m.contentUrl,markerInfowindow=new google.maps.InfoWindow;marker.addListener("click",function(){markerInfowindow.open(map,marker),getInfoWindowContent(contentUrl).then(function(result){markerInfowindow.setContent(result)})}),clusterMarkers.push(marker),counter++})}markerClusterer=new MarkerClusterer(map,clusterMarkers,options)}),scope.$watch("config.mapHeight",function(newValue,oldValue){""!==newValue&&newValue!==oldValue&&(console.log("Config height change to %s",newValue),$("#map").height(newValue+"px"),google.maps.event.trigger(map,"resize"))}),scope.$watch("config.mapWidth",function(newValue,oldValue){""!==newValue&&newValue!==oldValue&&(console.log("Config width change to %s",newValue),google.maps.event.trigger(map,"resize"))})}function getInfoWindowContent(url){return console.log("Getting content from %s",url),$http({method:"GET",withCredentials:!0,url:url}).then(function(response){return response.data})}var map,mapElement,markerClusterer,clusterMarkers=[],randomMin=-.05,randomMax=.05,options={imagePath:"https://raw.githubusercontent.com/googlemaps/js-marker-clusterer/gh-pages/images/m",gridSize:scope.config.clusterGridSize,styles:scope.config.clusterStyles};initMap()}return{restrict:"E",template:"<div id='map' class='watgAngularGoogleMap'></div>",replace:"true",scope:{config:"=",selectedMapTypeId:"="},link:link}}angular.module("watgGoogleMapModule").directive("watgGoogleMap",["$http",watgGoogleMapDirective])}();